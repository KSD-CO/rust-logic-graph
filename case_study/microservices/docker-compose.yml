services:
  # PostgreSQL Database - OMS
  postgres-oms:
    image: postgres:17
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: oms_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_oms_data:/var/lib/postgresql/data
      - ./sql/init_oms_db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database - Inventory
  postgres-inventory:
    image: postgres:17
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: inventory_db
    ports:
      - "5434:5432"
    volumes:
      - postgres_inventory_data:/var/lib/postgresql/data
      - ./sql/init_inventory_db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database - Supplier
  postgres-supplier:
    image: postgres:17
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: supplier_db
    ports:
      - "5435:5432"
    volumes:
      - postgres_supplier_data:/var/lib/postgresql/data
      - ./sql/init_supplier_db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database - UOM
  postgres-uom:
    image: postgres:17
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: uom_db
    ports:
      - "5436:5432"
    volumes:
      - postgres_uom_data:/var/lib/postgresql/data
      - ./sql/init_uom_db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # OMS Service
  oms-service:
    build:
      context: .
      dockerfile: services/oms-service/Dockerfile
    environment:
      PORT: 8081              # REST API
      GRPC_PORT: 50051        # gRPC server
      DB_USER: postgres
      DB_PASSWORD: password
      DB_HOST: postgres-oms
      DB_PORT: 5432
      DB_NAME: oms_db
    ports:
      - "8081:8081"           # REST API
      - "50051:50051"         # gRPC
    depends_on:
      postgres-oms:
        condition: service_healthy

  # Inventory Service
  inventory-service:
    build:
      context: .
      dockerfile: services/inventory-service/Dockerfile
    environment:
      PORT: 8082              # REST API
      GRPC_PORT: 50052        # gRPC server
      DB_USER: postgres
      DB_PASSWORD: password
      DB_HOST: postgres-inventory
      DB_PORT: 5432
      DB_NAME: inventory_db
    ports:
      - "8082:8082"           # REST API
      - "50052:50052"         # gRPC
    depends_on:
      postgres-inventory:
        condition: service_healthy

  # Supplier Service
  supplier-service:
    build:
      context: .
      dockerfile: services/supplier-service/Dockerfile
    environment:
      PORT: 8083              # REST API
      GRPC_PORT: 50053        # gRPC server
      DB_USER: postgres
      DB_PASSWORD: password
      DB_HOST: postgres-supplier
      DB_PORT: 5432
      DB_NAME: supplier_db
    ports:
      - "8083:8083"           # REST API
      - "50053:50053"         # gRPC
    depends_on:
      postgres-supplier:
        condition: service_healthy

  # UOM Service
  uom-service:
    build:
      context: .
      dockerfile: services/uom-service/Dockerfile
    environment:
      PORT: 8084              # REST API
      GRPC_PORT: 50054        # gRPC server
      DB_USER: postgres
      DB_PASSWORD: password
      DB_HOST: postgres-uom
      DB_PORT: 5432
      DB_NAME: uom_db
    ports:
      - "8084:8084"           # REST API
      - "50054:50054"         # gRPC
    depends_on:
      postgres-uom:
        condition: service_healthy

  # Rule Engine Service
  rule-engine-service:
    build:
      context: .
      dockerfile: services/rule-engine-service/Dockerfile
    environment:
      PORT: 8085
    ports:
      - "8085:8085"

  # PO Service
  po-service:
    build:
      context: .
      dockerfile: services/po-service/Dockerfile
    environment:
      PORT: 8086
    ports:
      - "8086:8086"

  # Orchestrator Service (API Gateway)
  orchestrator-service:
    build:
      context: .
      dockerfile: services/orchestrator-service/Dockerfile
    environment:
      PORT: 8080
      # gRPC URLs for high-performance inter-service communication
      OMS_GRPC_URL: http://oms-service:50051
      INVENTORY_GRPC_URL: http://inventory-service:50052
      SUPPLIER_GRPC_URL: http://supplier-service:50053
      UOM_GRPC_URL: http://uom-service:50054
      # REST URLs for services not yet migrated
      RULE_ENGINE_SERVICE_URL: http://rule-engine-service:8085
      PO_SERVICE_URL: http://po-service:8086
    ports:
      - "8080:8080"
    depends_on:
      - oms-service
      - inventory-service
      - supplier-service
      - uom-service
      - rule-engine-service
      - po-service

volumes:
  postgres_oms_data:
  postgres_inventory_data:
  postgres_supplier_data:
  postgres_uom_data:
